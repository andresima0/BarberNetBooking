@page
@model BarberNetBooking.Pages.Admin.Availability.IndexModel
@{
    Layout = "/Pages/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "Disponibilidade";
}

@if (!string.IsNullOrEmpty(Model.SuccessMessage))
{
    <div class="alert alert-success">@Model.SuccessMessage</div>
}

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}

<section class="card">
    <h2>Regras semanais</h2>
    <form method="get">
        <label>Barbeiro
            <select name="SelectedBarberId" asp-items="Model.BarberOptions" onchange="this.form.submit()">
            </select>
        </label>
    </form>
    
    <form method="post" asp-page-handler="SaveWeek">
        <input type="hidden" asp-for="SelectedBarberId" />
        <div style="overflow-x: auto;">
            <table class="tbl">
                <thead>
                    <tr>
                        <th>Dia</th>
                        <th>Início</th>
                        <th>Almoço Início</th>
                        <th>Almoço Fim</th>
                        <th>Fim</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                @for (int i = 0; i < Model.Week.Count; i++)
                {
                    <tr>
                        <td><strong>@Model.GetDayName(Model.Week[i].DayOfWeek)</strong></td>
                        <td>
                            <select asp-for="Week[i].StartTime" 
                                    style="min-width: 100px;"
                                    class="form-control">
                                @for (int h = 0; h < 24; h++)
                                {
                                    for (int m = 0; m < 60; m += 15)
                                    {
                                        var time = new TimeOnly(h, m);
                                        <option value="@time.ToString("HH:mm")">@time.ToString("HH:mm")</option>
                                    }
                                }
                            </select>
                            <input type="hidden" asp-for="Week[i].DayOfWeek" />
                        </td>
                        <td>
                            <select asp-for="Week[i].LunchStartTime" 
                                    style="min-width: 100px;"
                                    class="form-control">
                                <option value="">-- Sem almoço --</option>
                                @for (int h = 0; h < 24; h++)
                                {
                                    for (int m = 0; m < 60; m += 15)
                                    {
                                        var time = new TimeOnly(h, m);
                                        <option value="@time.ToString("HH:mm")">@time.ToString("HH:mm")</option>
                                    }
                                }
                            </select>
                        </td>
                        <td>
                            <select asp-for="Week[i].LunchEndTime" 
                                    style="min-width: 100px;"
                                    class="form-control">
                                <option value="">-- Sem almoço --</option>
                                @for (int h = 0; h < 24; h++)
                                {
                                    for (int m = 0; m < 60; m += 15)
                                    {
                                        var time = new TimeOnly(h, m);
                                        <option value="@time.ToString("HH:mm")">@time.ToString("HH:mm")</option>
                                    }
                                }
                            </select>
                        </td>
                        <td>
                            <select asp-for="Week[i].EndTime" 
                                    style="min-width: 100px;"
                                    class="form-control">
                                @for (int h = 0; h < 24; h++)
                                {
                                    for (int m = 0; m < 60; m += 15)
                                    {
                                        var time = new TimeOnly(h, m);
                                        <option value="@time.ToString("HH:mm")">@time.ToString("HH:mm")</option>
                                    }
                                }
                            </select>
                        </td>
                        <td>
                            <select asp-for="Week[i].IsClosed" style="min-width: 100px;">
                                <option value="false">Aberto</option>
                                <option value="true">Fechado</option>
                            </select>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
        
        <div style="margin-top: 16px;">
           
            <button class="btn" type="submit">Salvar semana</button>
        </div>
    </form>
</section>

<section class="card light">
    <h3>Exceções (folgas)</h3>
    <form method="post" asp-page-handler="AddTimeOff">
        <input type="hidden" asp-for="SelectedBarberId" />
        <div class="grid">
            <label>Data 
                <input asp-for="NewTimeOff.Date"
                       asp-format="{0:dd/MM/yyyy}"
                       type="text"
                       class="form-control js-date"
                       placeholder="dd/mm/aaaa"
                       autocomplete="off"
                       aria-haspopup="dialog" />
                <span asp-validation-for="NewTimeOff.Date" class="text-danger"></span>
            </label>
            <label>Motivo 
                <input asp-for="NewTimeOff.Reason" 
                       placeholder="Ex: Férias, Folga pessoal..." />
            </label>
        </div>
        <button class="btn" type="submit">Adicionar folga</button>
    </form>

    @if (Model.TimeOffs.Any())
    {
        <table class="tbl" style="margin-top:12px;">
            <thead><tr><th>Data</th><th>Motivo</th><th class="right">Ações</th></tr></thead>
            <tbody>
            @foreach (var t in Model.TimeOffs)
            {
                <tr>
                    <td>@t.Date.ToBrazilianDate()</td>
                    <td>@(string.IsNullOrWhiteSpace(t.Reason) ? "-" : t.Reason)</td>
                    <td class="right">
                        <form method="post" asp-page-handler="DeleteTimeOff">
                            <input type="hidden" name="id" value="@t.Id" />
                            <input type="hidden" asp-for="SelectedBarberId" />
                            <button class="btn" type="submit" 
                                    onclick="return confirm('Deseja remover esta folga?');">
                                Remover
                            </button>
                        </form>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    }
    else
    {
        <p style="margin-top:12px;"><em>Nenhuma folga cadastrada.</em></p>
    }
</section>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            flatpickr(".js-date", {
                dateFormat: "d/m/Y",
                locale: flatpickr.l10ns.pt,
                allowInput: false,
                clickOpens: true,
                disableMobile: true,
                minDate: "today"
            });

            document.querySelectorAll(".js-date").forEach(function (el) {
                el.addEventListener("focus", function () { if (el._flatpickr) el._flatpickr.open(); });
                el.addEventListener("click", function () { if (el._flatpickr) el._flatpickr.open(); });
            });
        });
    </script>
}