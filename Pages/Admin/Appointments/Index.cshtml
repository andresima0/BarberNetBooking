@page
@model BarberNetBooking.Pages.Admin.Appointments.IndexModel

@{
Layout = "/Pages/Shared/_AdminLayout.cshtml";
ViewData["Title"] = "Agendamentos";
}

<section class="card">
    <h2>Filtrar</h2>
    <form method="get" class="booking-form">
        <div class="grid form-grid">

            <label class="form-group">
                Data Início
                <input asp-for="Filters.StartTime"
                       asp-format="{0:dd/MM/yyyy}"
                       type="text"
                       class="form-control js-date"
                       placeholder="dd/mm/aaaa"
                       autocomplete="off"
                       aria-haspopup="dialog" />
                <span asp-validation-for="Filters.StartTime" class="text-danger"></span>
            </label>

            <label class="form-group">
                Data Fim
                <input asp-for="Filters.EndTime"
                       asp-format="{0:dd/MM/yyyy}"
                       type="text"
                       class="form-control js-date"
                       placeholder="dd/mm/aaaa"
                       autocomplete="off"
                       aria-haspopup="dialog" />
                <span asp-validation-for="Filters.EndTime" class="text-danger"></span>
            </label>

            <label class="form-group">
                Barbeiro
                <select asp-for="Filters.BarberId" asp-items="Model.BarberOptions" class="form-control">
                    <option value="">Todos</option>
                </select>
            </label>

            <label class="form-group">
                Status
                <select asp-for="Filters.Status" class="form-control">
                    <option value="">Todos</option>
                    <option value="Confirmed">Confirmado</option>
                    <option value="Cancelled">Cancelado</option>
                </select>
            </label>
        </div>

        <div style="margin-top: 15px;">
            <button class="btn btn-primary" type="submit">Aplicar filtros</button>
        </div>
    </form>
</section>

<section class="card light">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3 style="margin: 0;">Resultados (@Model.Items.Count agendamentos)</h3>

        <div style="display: flex; gap: 12px;">
            <button type="button" class="btn" id="toggleDeleteMode" onclick="toggleDeleteMode()">
                Selecionar para apagar
            </button>

            <button type="button" class="btn btn-danger" id="deleteSelectedBtn" style="display: none;" onclick="deleteSelected()">
                Apagar selecionados
            </button>

            <button type="button" class="btn" id="cancelDeleteMode" style="display: none;" onclick="cancelDeleteMode()">
                Cancelar
            </button>
        </div>
    </div>

    @if (!Model.Items.Any())
    {
    <p class="empty-state">Nenhum agendamento encontrado com os filtros selecionados.</p>
    }
    else
    {
    <table class="tbl">
        <thead>
        <tr>
            <th id="checkboxHeader" style="display: none; width: 40px;">
                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" />
            </th>
            <th>Data</th>
            <th>Hora</th>
            <th>Serviço</th>
            <th>Barbeiro</th>
            <th>Cliente</th>
            <th>Status</th>
            <th class="right">Ações</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var a in Model.Items)
        {
        <tr>
            <td class="checkbox-cell" style="display: none;">
                <input type="checkbox"
                       name="selectedIds"
                       value="@a.Id"
                       class="appointment-checkbox"
                       form="deleteForm" />
            </td>
            <td>@a.Date.ToBrazilianDate()</td>
            <td>@a.StartTime.ToDisplayTime()</td>
            <td>@a.Service?.Name</td>
            <td>@a.Barber?.Name</td>
            <td>
                @a.CustomerEmail<br />
                <small>@a.CustomerPhone</small>
            </td>
            <td>
                @if (a.Status == BarberNetBooking.Models.AppointmentStatus.Confirmed)
                {
                <span class="status-badge status-confirmed">✓ Confirmado</span>
                }
                else
                {
                <span class="status-badge status-cancelled">✗ Cancelado</span>
                }
            </td>
            <td class="right action-cell">
                @if (a.Status == BarberNetBooking.Models.AppointmentStatus.Confirmed)
                {
                <form method="post" asp-page-handler="Cancel" style="display:inline">
                    <input type="hidden" name="id" value="@a.Id" />
                    <button class="btn btn-danger" type="submit"
                            onclick="return confirm('Deseja cancelar este agendamento?');">
                        Cancelar
                    </button>
                </form>

                <details style="display:inline-block; margin-left:8px;">
                    <summary>Remarcar</summary>
                    <form method="post" asp-page-handler="Reschedule" class="mt-2">
                        <input type="hidden" name="id" value="@a.Id" />
                        <div class="mb-2">
                            <label class="form-label d-block">Data</label>
                            <input name="date"
                                   type="text"
                                   class="form-control js-date"
                                   placeholder="dd/mm/aaaa"
                                   autocomplete="off"
                                   value="@a.Date.ToString("dd/MM/yyyy")" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label d-block">Hora</label>
                            <input name="time"
                                   class="form-control"
                                   placeholder="HH:mm"
                                   value="@a.StartTime.ToDisplayTime()" />
                        </div>
                        <button class="btn btn-primary" type="submit">Salvar</button>
                    </form>
                </details>
                }
            </td>
        </tr>
        }
        </tbody>
    </table>

    <!-- Form dedicado à exclusão múltipla (fora da tabela; sem inputs próprios) -->
    <form method="post" asp-page-handler="DeleteMultiple" id="deleteForm">
        @Html.AntiForgeryToken()
    </form>
    }
</section>

@section Scripts {
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Inicializa todos os campos .js-date no padrão dd/MM/yyyy
        flatpickr(".js-date", {
            dateFormat: "d/m/Y",
            locale: flatpickr.l10ns.pt,
            allowInput: false,
            clickOpens: true,
            disableMobile: true
        });

        document.querySelectorAll(".js-date").forEach(function (el) {
            el.addEventListener("focus", function () { if (el._flatpickr) el._flatpickr.open(); });
            el.addEventListener("click", function () { if (el._flatpickr) el._flatpickr.open(); });
        });
    });

    let isDeleteMode = false;

    function toggleDeleteMode() {
        isDeleteMode = true;

        // Mostra checkboxes
        document.getElementById('checkboxHeader').style.display = 'table-cell';
        document.querySelectorAll('.checkbox-cell').forEach(cell => {
            cell.style.display = 'table-cell';
        });

        // Esconde ações normais
        document.querySelectorAll('.action-cell').forEach(cell => {
            cell.style.display = 'none';
        });

        // Atualiza botões
        document.getElementById('toggleDeleteMode').style.display = 'none';
        document.getElementById('deleteSelectedBtn').style.display = 'inline-block';
        document.getElementById('cancelDeleteMode').style.display = 'inline-block';
    }

    function cancelDeleteMode() {
        isDeleteMode = false;

        // Esconde checkboxes
        document.getElementById('checkboxHeader').style.display = 'none';
        document.querySelectorAll('.checkbox-cell').forEach(cell => {
            cell.style.display = 'none';
        });

        // Mostra ações normais
        document.querySelectorAll('.action-cell').forEach(cell => {
            cell.style.display = 'table-cell';
        });

        // Atualiza botões
        document.getElementById('toggleDeleteMode').style.display = 'inline-block';
        document.getElementById('deleteSelectedBtn').style.display = 'none';
        document.getElementById('cancelDeleteMode').style.display = 'none';

        // Desmarca todos
        document.getElementById('selectAll').checked = false;
        document.querySelectorAll('.appointment-checkbox').forEach(cb => {
            cb.checked = false;
        });
    }

    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        document.querySelectorAll('.appointment-checkbox').forEach(cb => {
            cb.checked = selectAll.checked;
        });
    }

    function deleteSelected() {
        const checkboxes = document.querySelectorAll('.appointment-checkbox:checked');

        if (checkboxes.length === 0) {
            alert('Selecione pelo menos um agendamento para apagar.');
            return;
        }

        const count = checkboxes.length;
        const confirmMsg = count === 1
            ? 'Tem certeza que deseja apagar 1 agendamento? Esta ação não pode ser desfeita.'
            : `Tem certeza que deseja apagar ${count} agendamentos? Esta ação não pode ser desfeita.`;

        if (confirm(confirmMsg)) {
            document.getElementById('deleteForm').submit();
        }
    }
</script>

<style>
    .checkbox-cell {
        text-align: center;
        vertical-align: middle;
    }

    .appointment-checkbox,
    #selectAll {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    #checkboxHeader {
        text-align: center;
    }

    .btn-danger {
        background: linear-gradient(90deg, var(--danger), #dc2626);
    }

    .btn-danger:hover {
        filter: brightness(1.1);
    }
</style>
}
