@page
@model BarberNetBooking.Pages.IndexModel
@{
    ViewData["Title"] = "Agendamento";
}

@* SLOGAN NO TOPO (fora de qualquer outro bloco) *@
@if (!string.IsNullOrWhiteSpace(Model.ShopInfo?.Slogan))
{
    <section class="card" style="text-align: center; padding: 40px 20px; margin-top: 0;">
        <h4 style="font-size: 1.6rem; font-style: italic; color: var(--accent); margin: 0;">
            @Model.ShopInfo!.Slogan
        </h4>
    </section>
}

<section class="card light">
    <h2>Serviços & preços</h2>
    <table class="tbl">
        <thead>
        <tr>
            <th>Serviço</th>
            <th class="right">Preço</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var s in Model.Services)
        {
            <tr>
                <td>@s.Name</td>
                <td class="right">R$ @s.Price</td>
            </tr>
        }
        </tbody>
    </table>
</section>

<section class="card">
    <h2>Agende seu horário</h2>

    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="alert alert-success">@Model.SuccessMessage</div>
    }
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger">@Model.ErrorMessage</div>
    }

    <form method="post" id="bookingForm" class="booking-form">
        @Html.AntiForgeryToken()

        <div class="grid form-grid">
            <label class="form-group">
                Serviço *
                <select asp-for="Input.ServiceId"
                        asp-items="Model.ServiceOptions"
                        id="serviceSelect"
                        class="form-control"
                        required>
                    <option value="">Selecione um serviço</option>
                </select>
            </label>

            <label class="form-group">
                Barbeiro *
                <select asp-for="Input.BarberId"
                        asp-items="Model.BarberOptions"
                        id="barberSelect"
                        class="form-control"
                        required>
                    <option value="">Selecione um barbeiro</option>
                </select>
            </label>

            <label class="form-group">
                Data *
                <input asp-for="Input.Date"
                       asp-format="{0:dd/MM/yyyy}"
                       type="text"
                       class="form-control js-date"
                       placeholder="dd/mm/aaaa"
                       autocomplete="off"
                       aria-haspopup="dialog"
                       required/>
            </label>

            <label class="form-group">
                Horário *
                <select asp-for="Input.StartTime"
                        id="timeSelect"
                        class="form-control"
                        required
                        disabled>
                    <option value="">Primeiro selecione serviço, barbeiro e data</option>
                </select>
                <small class="form-text" id="loadingText" style="display:none;">
                    Carregando horários disponíveis...
                </small>
            </label>

            <label class="form-group">
                E-mail *
                <input asp-for="Input.CustomerEmail"
                       type="email"
                       class="form-control"
                       placeholder="seuemail@exemplo.com"
                       required/>
            </label>

            <label class="form-group">
                Telefone *
                <input asp-for="Input.CustomerPhone"
                       type="tel"
                       class="form-control"
                       placeholder="(11) 99999-9999"
                       required/>
            </label>
        </div>

        <button type="submit"
                class="btn btn-primary btn-lg"
                id="submitBtn"
                disabled>
            Confirmar agendamento
        </button>

        <div asp-validation-summary="All" class="errors"></div>
    </form>
</section>

@* Seções de informações da barbearia (slogan NÃO fica mais aqui) *@
@if (Model.ShopInfo != null)
{
    @* Sobre Nós *@
    @if (!string.IsNullOrWhiteSpace(Model.ShopInfo.AboutUs))
    {
        <section class="card light">
            <h2>✂️ Sobre Nós</h2>
            <p style="white-space: pre-line; line-height: 1.8;">@Model.ShopInfo.AboutUs</p>
        </section>
    }

    @* Horário de Funcionamento *@
    @if (Model.WorkingHours.Any())
    {
        <section class="card">
            <h2>🕒 Horário de Funcionamento</h2>
            <table class="tbl">
                <tbody>
                @foreach (var wh in Model.WorkingHours.OrderBy(w => w.DayOfWeek))
                {
                    <tr>
                        <td style="font-weight: 600;">@Model.GetDayName(wh.DayOfWeek)</td>
                        <td class="right">
                            @if (wh.IsClosed)
                            {
                                <span style="color: var(--danger);">Fechado</span>
                            }
                            else if (wh.LunchStartTime.HasValue && wh.LunchEndTime.HasValue)
                            {
                                <!-- dois blocos (antes e depois do almoço) -->
                                <span>@wh.StartTime.ToString("HH:mm") – @wh.LunchStartTime!.Value.ToString("HH:mm")</span>
                                <span style="display:inline-block; width: 28px;"></span>
                                <span>@wh.LunchEndTime!.Value.ToString("HH:mm") – @wh.EndTime.ToString("HH:mm")</span>
                            }
                            else
                            {
                                <!-- bloco contínuo (sem almoço) -->
                                <span>@wh.StartTime.ToString("HH:mm") – @wh.EndTime.ToString("HH:mm")</span>
                            }
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        </section>
    }

    @* Contato e Endereço *@
    @if (!string.IsNullOrWhiteSpace(Model.ShopInfo.Phone) ||
         !string.IsNullOrWhiteSpace(Model.ShopInfo.Email) ||
         !string.IsNullOrWhiteSpace(Model.ShopInfo.Address))
    {
        <section class="card light">
            <h2>📞 Contato e Localização</h2>

            <div class="grid">
                @if (!string.IsNullOrWhiteSpace(Model.ShopInfo.Phone) ||
                     !string.IsNullOrWhiteSpace(Model.ShopInfo.Email))
                {
                    <div>
                        <h3 style="margin-bottom: 12px;">Contato</h3>
                        @if (!string.IsNullOrWhiteSpace(Model.ShopInfo.Phone))
                        {
                            <p style="margin: 8px 0;">
                                <strong>📱 Telefone:</strong>
                                <a href="tel:@Model.ShopInfo.Phone" style="color: var(--accent);">
                                    @Model.ShopInfo.Phone
                                </a>
                            </p>
                        }
                        @if (!string.IsNullOrWhiteSpace(Model.ShopInfo.Email))
                        {
                            <p style="margin: 8px 0;">
                                <strong>✉️ E-mail:</strong>
                                <a href="mailto:@Model.ShopInfo.Email" style="color: var(--accent);">
                                    @Model.ShopInfo.Email
                                </a>
                            </p>
                        }
                    </div>
                }

                @if (!string.IsNullOrWhiteSpace(Model.ShopInfo.Instagram) ||
                     !string.IsNullOrWhiteSpace(Model.ShopInfo.Facebook))
                {
                    <div>
                        <h3 style="margin-bottom: 12px;">Redes Sociais</h3>
                        @if (!string.IsNullOrWhiteSpace(Model.ShopInfo.Instagram))
                        {
                            <p style="margin: 8px 0%;">
                                <strong>📷 Instagram:</strong>
                                <a href="https://instagram.com/@(Model.ShopInfo.Instagram.TrimStart('@'))"
                                   target="_blank"
                                   style="color: var(--accent);">
                                    @Model.ShopInfo.Instagram.TrimStart('@')
                                </a>
                            </p>
                        }
                        @if (!string.IsNullOrWhiteSpace(Model.ShopInfo.Facebook))
                        {
                            <p style="margin: 8px 0%;">
                                <strong>👥 Facebook:</strong>
                                <a href="@(Model.ShopInfo.Facebook.StartsWith("http") ? Model.ShopInfo.Facebook : "https://facebook.com/" + Model.ShopInfo.Facebook)"
                                   target="_blank"
                                   style="color: var(--accent);">
                                    @Model.ShopInfo.Facebook
                                </a>
                            </p>
                        }
                    </div>
                }
            </div>

            @if (!string.IsNullOrWhiteSpace(Model.ShopInfo.Address))
            {
                <div style="margin-top: 24px;">
                    <h3 style="margin-bottom: 12px;">📍 Endereço</h3>
                    <p style="margin: 0; font-size: 16px;">
                        @Model.ShopInfo.Address
                        @if (!string.IsNullOrWhiteSpace(Model.ShopInfo.City))
                        {
                            <text>
                                <br/>@Model.ShopInfo.City@(!string.IsNullOrWhiteSpace(Model.ShopInfo.State) ? $" - {Model.ShopInfo.State}" : "")</text>
                        }
                        @if (!string.IsNullOrWhiteSpace(Model.ShopInfo.ZipCode))
                        {
                            <text><br/>CEP: @Model.ShopInfo.ZipCode</text>
                        }
                    </p>
                </div>
            }

            @* Mapa incorporado *@
            @if (!string.IsNullOrWhiteSpace(Model.ShopInfo.MapEmbedUrl))
            {
                <div style="margin-top: 24px;">
                    <h3 style="margin-bottom: 12px;">🗺️ Como Chegar</h3>
                    <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; 
                                border-radius: 12px; border: 1px solid var(--border);">
                        <iframe src="@Model.ShopInfo.MapEmbedUrl"
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;"
                                allowfullscreen=""
                                loading="lazy"
                                referrerpolicy="no-referrer-when-downgrade">
                        </iframe>
                    </div>
                </div>
            }
        </section>
    }
}

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>

    <script>
        const form = document.getElementById('bookingForm');
        const serviceSel = document.getElementById('serviceSelect');
        const barberSel = document.getElementById('barberSelect');
        const dateInput = document.querySelector('.js-date');
        const timeSelect = document.getElementById('timeSelect');
        const submitBtn = document.getElementById('submitBtn');
        const loadingText = document.getElementById('loadingText');

        try {
            if (window.flatpickr && dateInput) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);

                flatpickr(".js-date", {
                    dateFormat: "d/m/Y",
                    locale: flatpickr.l10ns.pt,
                    minDate: tomorrow,
                    defaultDate: tomorrow,
                    allowInput: false,
                    clickOpens: true,
                    disableMobile: true,
                    disable: [
                        function (date) {
                            // Desabilita hoje e todas as datas passadas
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            return date < tomorrow;
                        }
                    ],
                    onChange: () => loadAvailableSlots()
                });

                document.querySelectorAll(".js-date").forEach(function (el) {
                    el.addEventListener("focus", function () {
                        if (el._flatpickr) el._flatpickr.open();
                    });
                    el.addEventListener("click", function () {
                        if (el._flatpickr) el._flatpickr.open();
                    });
                });
            } else if (dateInput) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const minDate = tomorrow.toISOString().slice(0, 10);
                dateInput.setAttribute('type', 'date');
                dateInput.setAttribute('min', minDate);
                dateInput.value = minDate;
            }
        } catch {
            if (dateInput) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const minDate = tomorrow.toISOString().slice(0, 10);
                dateInput.setAttribute('type', 'date');
                dateInput.setAttribute('min', minDate);
                dateInput.value = minDate;
            }
        }

        function getCsrf() {
            const el = form.querySelector('input[name=\"__RequestVerificationToken\"]');
            return el ? el.value : '';
        }

        // Converte dd/MM/yyyy -> yyyy-MM-dd para o handler
        function normalizeDate(val) {
            if (!val) return '';
            if (/^\\d{4}-\\d{2}-\\d{2}$/.test(val)) return val;
            const m = val.match(/^(\\d{2})\/(\\d{2})\/(\\d{4})$/);
            if (m) return `${m[3]}-${m[2]}-${m[1]}`;
            if (dateInput && dateInput.valueAsDate instanceof Date) {
                const d = dateInput.valueAsDate;
                const pad = n => String(n).padStart(2, '0');
                return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
            }
            return val;
        }

        async function loadAvailableSlots() {
            const serviceId = serviceSel.value;
            const barberId = barberSel.value;
            const rawDate = dateInput ? dateInput.value : '';
            const dateIso = normalizeDate(rawDate);

            timeSelect.disabled = true;
            timeSelect.innerHTML = '<option value=\"\">Carregando...</option>';
            submitBtn.disabled = true;
            loadingText.style.display = 'block';

            if (!serviceId || !barberId || !dateIso) {
                timeSelect.innerHTML = '<option value=\"\">Primeiro selecione serviço, barbeiro e data</option>';
                loadingText.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(
                    `?handler=AvailableSlots&barberId=${encodeURIComponent(barberId)}&serviceId=${encodeURIComponent(serviceId)}&date=${encodeURIComponent(dateIso)}`,
                    {headers: {'RequestVerificationToken': getCsrf()}}
                );
                if (!response.ok) throw new Error('Erro ao buscar horários');

                const data = await response.json();
                loadingText.style.display = 'none';

                if (data.error) {
                    timeSelect.innerHTML = `<option value=\"\">${data.error}</option>`;
                    return;
                }

                if (data.slots && data.slots.length > 0) {
                    timeSelect.innerHTML = '<option value=\"\">Selecione um horário</option>';
                    data.slots.forEach(slot => {
                        const opt = document.createElement('option');
                        opt.value = slot.value;
                        opt.textContent = slot.text;
                        timeSelect.appendChild(opt);
                    });
                    timeSelect.disabled = false;
                } else {
                    timeSelect.innerHTML = '<option value=\"\">Nenhum horário disponível neste dia</option>';
                }
            } catch (err) {
                console.error(err);
                timeSelect.innerHTML = '<option value=\"\">Erro ao carregar horários. Tente novamente.</option>';
                loadingText.style.display = 'none';
            }
        }

        timeSelect.addEventListener('change', () => {
            submitBtn.disabled = !timeSelect.value;
        });
        serviceSel.addEventListener('change', loadAvailableSlots);
        barberSel.addEventListener('change', loadAvailableSlots);
        if (dateInput) dateInput.addEventListener('change', loadAvailableSlots);
    </script>
}